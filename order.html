<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#fff}
.wrapper{max-width:420px;margin:auto;padding:16px}
.header{font-size:18px;font-weight:700;margin-bottom:12px}

.product{display:flex;gap:10px;margin:14px 0;position:relative}
.product img{width:70px;height:70px;border-radius:6px;object-fit:cover}
.qty-badge{
  position:absolute;left:-8px;top:-8px;
  width:22px;height:22px;border-radius:50%;
  background:#777;color:#fff;font-size:12px;
  display:flex;align-items:center;justify-content:center
}
.info{flex:1}
.info strong{display:block}

.box{border:1px solid #ddd;border-radius:8px;padding:12px;margin:14px 0}
.row{display:flex;justify-content:space-between;margin:6px 0}

label{font-weight:700;margin-top:12px;display:block}
.input{display:flex;align-items:center;border:1px solid #ccc;border-radius:6px;overflow:hidden;margin-top:6px}
.input span{padding:10px;background:#eee}
.input input{border:none;flex:1;padding:10px;font-size:15px}

.radio{margin:14px 0}
.upload{display:none;margin-top:30px}

button{
  width:100%;padding:14px;border:none;border-radius:25px;
  background:#000;color:#fff;font-size:16px;font-weight:700;
  cursor:pointer
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="header">Please fill in the form to order</div>

  <div id="products"></div>

  <div class="box">
    <div class="row"><span>Subtotal</span><strong id="subtotal">ETB 0</strong></div>
    <div class="row"><span>Total</span><strong id="total">ETB 0</strong></div>
  </div>

  <label>Full Name*</label>
  <div class="input"><span>üë§</span><input id="name"></div>

  <label>Phone*</label>
  <div class="input"><span>üìû</span><input id="phone"></div>

  <div class="radio">
    <label><input type="radio" name="pay" value="Cash" checked> Cash</label><br>
    <label><input type="radio" name="pay" value="Transfer"> Transfer</label>
  </div>

  <div class="upload" id="uploadBox">
    <label>·ã®·ä®·çà·àâ·â†·âµ screenshot ·ã´·àµ·åà·â°*</label>
    <input type="file" id="proof" accept="image/*">
  </div>
<br>
  <button onclick="submitOrder()">ORDER</button>
</div>


<script>
const CART_KEY = "cartItems";
const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
const productsDiv = document.getElementById("products");
let subtotal = 0;

/* RENDER PRODUCTS */
if(cart.length === 0){
  productsDiv.innerHTML = "<p>No products in cart</p>";
}

cart.forEach(p=>{
  subtotal += p.price * p.qty;
  productsDiv.innerHTML += `
    <div class="product">
      <div class="qty-badge">${p.qty}</div>
      <img src="${p.image || 'https://via.placeholder.com/150'}">
      <div class="info">
        <strong>${p.name}</strong>
        ETB ${(p.price * p.qty).toFixed(2)}
      </div>
    </div>
  `;
});

document.getElementById("subtotal").innerText = "ETB " + subtotal.toFixed(2);
document.getElementById("total").innerText = "ETB " + subtotal.toFixed(2);

/* PAYMENT TOGGLE */
document.querySelectorAll("input[name='pay']").forEach(r=>{
  r.addEventListener("change",()=>{
    document.getElementById("uploadBox").style.display =
      r.value === "Transfer" && r.checked ? "block" : "none";
  });
});

async function submitOrder(){
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const payment = document.querySelector("input[name='pay']:checked").value;
  const proof = document.getElementById("proof");

  if(!name || !phone){
    alert("Please fill name and phone");
    return;
  }

  if(payment === "Transfer" && !proof.files.length){
    alert("Upload transfer proof");
    return;
  }

  /* TELEGRAM CONFIG */
  const BOT_TOKEN = "8458097036:AAG29CuWdhYBKspr3BS6N-yWeXkkBEVUzTo";
  const CHAT_ID = "5335234629";
  const API = `https://api.telegram.org/bot8458097036:AAG29CuWdhYBKspr3BS6N-yWeXkkBEVUzTo`;

  /* SEND MESSAGE */
let message = `üõí NEW ORDER

üë§ Name: ${name}
üìû Phone: ${phone}
üí≥ Payment: ${payment}

üì¶ Products:
`;


for (const p of cart) {

  // 1Ô∏è‚É£ SEND PRODUCT INFO (TEXT)
  await fetch(`${API}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: 5335234629,
      text:
`üßæ Product:
üì¶ Name: ${p.name}
üî¢ Qty: ${p.qty}
üíµ Price: ETB ${p.price}
üí∞ Subtotal: ETB ${(p.price * p.qty).toFixed(2)}`
    })
  });

  // 2Ô∏è‚É£ SEND PRODUCT IMAGE (CLOUDINARY URL)
function smallCloudinary(url) {
  return url.replace(
    "/upload/",
    "/upload/w_300,h_300,c_fit,q_60,f_jpg/"
  );
}



  await fetch(`${API}/sendDocument`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: 5335234629,
      document: smallCloudinary(p.image),
      caption: `${p.name} x${p.qty} = ETB ${(p.price * p.qty).toFixed(2)}`
    })
  });


}

await fetch(`${API}/sendMessage`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    chat_id: 5335234629,
    text: `üí∞ TOTAL ORDER AMOUNT: ETB ${subtotal.toFixed(2)}`
  })
});


  /* SEND TRANSFER PROOF ONLY */
 if(payment === "Transfer" && proof.files.length){
  const form = new FormData();
  form.append("chat_id", 5335234629);
  form.append("document", proof.files[0]); // ‚úÖ change from 'photo' to 'document'
  form.append("caption", "üí≥ Transfer Proof");

  await fetch(`${API}/sendDocument`, {  // ‚úÖ change endpoint
    method: "POST",
    body: form
  });
}



  /* CLEAR CART */
  localStorage.removeItem(CART_KEY);
  window.location.href = "thankyou.html";
}
</script>
</body>
</html>